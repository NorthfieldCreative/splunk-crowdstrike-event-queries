event_simpleName=AsepValueUpdate RegObjectName="\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Control\\Print\\Environments\\Windows x64\\Drivers\\Version-3\\123*" RegValueName="Data File" RegStringValue=* RegOperationType_decimal=1
| lookup local=true aid_master aid OUTPUT Version MachineDomain OU SiteName
| eval ProductType=case(ProductType = "1","Workstation", ProductType = "2","Domain Controller", ProductType = "3","Server") 
| stats count as dllCount values(RegStringValue) as registryString, values(RegObjectName) as registryName by aid, ComputerName, ProductType, Version, MachineDomain, OU, SiteName


print spooler spawning processes that we do not expect:

event_platform=win event_simpleName=ProcessRollup2 (ParentBaseFileName=spoolsv.exe AND FileName!=WerMgr.exe) 
| stats dc(aid) as uniqueEndpoint count(aid) as executionCount by FileName SHA256HashData
| sort + executionCount



profile what spoolsv.exe is loading into the call stack:

event_platform=win event_simpleName=ProcessRollup2 FileName=spoolsv.exe
| eval CallStackModuleNames=split(CallStackModuleNames, "|")
| eval n=mvfilter(match(CallStackModuleNames, "(.*dll|.*exe)"))
| rex field=n ".*\\\\Device\\\\HarddiskVolume\d+(?<loadedFile>.*(\.dll|\.exe)).*"
| stats values(FileName) as fileName dc(SHA256HashData) as SHA256values dc(aid) as endpointCount count(aid) as loadCount by loadedFile
| sort + loadCount

